# Kilosort3 Docker Image

This documentation is intended to show how to create a Docker image with Matlab compiled implementation of Kilosort3 sorter. The main goal of this project is to avoid the requirement of Matlab Licenses and also abstract the installation and setup steps to run kilosort

There are four main steps to generate a functional kilosort3-compiled docker image:

1. Kilosort Setup
2. Compile Kilosort3 as Standalone Application
3. Create a (base) docker image with Matlab Runtime and the compiled application from step 2
4. Extend the docker image from step 3 for improvements and fixes

## Requirements
- Packaging a MATLAB Docker image is supported on Linux only
- Docker
- Matlab
- NVIDIA GPU and CUDA capabilities

### Matlab Requirements
- MATLAB Compiler
- Parallel Computing Toolbox
- Signal Processing Toolbox
- Statistics and Machine Learning Toolbox

Licenses for Matlab and toolboxes are needed only for compiling kilosort as Standalone Application and to generate the base Docker image. After this process, no license will be required, either to extend the base image or to run the sorter.

## Kilosort Setup 
- Git clone or Download kilosort [source code](https://github.com/MouseLand/Kilosort)
- Open Matlab
- Compile Kilosort mexfiles:
  - Set Matlab's workspace folder to `<git-cloned-path>/Kilosort/CUDA`
  - In Matlab console run:
    ```matlab
    >> mexGPUall
    ```

## Compiling Kilosort as Matlab's Standalone Application
- Set Matlab's workspace folder to `/path/to/spikeinterface-dockerfiles/kilosort3-compiled/matlab_files`
- Run `mcc` command with `utils` folder and kilosort path:
```
>> mcc -m ks3_compiled.m -a utils -a  <git-cloned-path>/Kilosort
```

## Generating Base Docker Image
- To generate the base docker image (called `ks3-matlab-base`) with the compiled application, run the following command in Matlab console:
```matlab
>> compiler.package.docker('ks3_compiled', 'requiredMCRProducts.txt', 'ImageName', 'ks3-matlab-base')
```

- [Optional] Files generated by Matlab Compiler can be deleted:
  - In your terminal, go to the folder for this project:
  ```
  $ cd /path/to/spikeinterface-dockerfiles/kilosort3-compiled
  ```
  - Run `rm` command:
  ```
  $ rm -r \
    matlab_files/includedSupportPackages.txt \
    matlab_files/ks3-matlab-basedocker/ \
    matlab_files/ks3_compiled \
    matlab_files/mccExcludedFiles.log \
    matlab_files/readme.txt \
    matlab_files/requiredMCRProducts.txt \
    matlab_files/run_ks3_compiled.sh \
    matlab_files/unresolvedSymbols.txt
  ```

## Extending Base Image and creating final image
The Dockerfile in this folder applies some fixes and updates to the base image generated automatically by Matlab in order to properly run kilosort3:

- In your terminal, go to the folder for this project:
```
$ cd /path/to/spikeinterface-dockerfiles/kilosort3-compiled
```

- Run build script:
```
$ source build.sh
```


## Running a container

- [nvidia-container-toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#setting-up-nvidia-container-toolkit) is required to run a docker with GPU capabilities

The base syntax to run dockerized kilosort is:

```
docker run -v <host-data-folder>:<docker-data-folder> -it spikeinterface/kilosort3-compiled-base:0.1.0 ks3_compiled [ARGS]
```

Notice that a volume has to be binded to a folder were all the data to run kilosort3 are stored

Currently the only ARG option is the folder where the data are stored (\<docker-data-folder\>)

This kilosort3 compiled version assumes that there are also two `.mat` files in this data folder:
1. `ops.mat`: Configurations (options) data
2. `chanMap.mat`: ChannelMap data

Both files are automatically generated by spikeinterface when running `run\_sorter`. If you want to run compiled kilosort independently you need to generate them manually (HOW TO still needs to be done)
