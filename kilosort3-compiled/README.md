# Kilosort3 Docker Image

This documentation is intended to show how to create a Docker image with Matlab compiled implementation of Kilosort3 sorter. The main goal of this project is to avoid the requirement of Matlab Licenses and also abstract the installation and setup steps to run kilosort

There are three main steps for generating a functional kilosort3-compiled docker image:

1. Compile kilosort3 as Standalone Application
2. Create a (base) docker image with Matlab Runtime and the compiled application from step 1
3. Extend the docker image from step 2 for improvements and fixes

## Requirements
- Packaging a MATLAB Docker image is supported on Linux only
- Docker
- Matlab
- NVIDIA GPU and CUDA capabilities
- [nvidia-container-toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#setting-up-nvidia-container-toolkit): required to run a docker with GPU capabilities

### Matlab Requirements
- MATLAB Compiler
- Parallel Computing Toolbox
- Signal Processing Toolbox
- Statistics and Machine Learning Toolbox

Licenses for Matlab and toolboxes are needed only for compiling ironclust as Standalone Application and to generate the base Docker image. After this process, no license will be required, either to extend the base image or to run the sorter.

## Compiling Kilosort as Matlab's Standalone Application
- Git clone or Download kilosort [source code](https://github.com/MouseLand/Kilosort)
- Open Matlab
- Set Matlab's workspace folder to `/path/to/spikeinterface-dockerfiles/kilosort3-compiled/matlab_files`
- Open Matlab's `Application Compiler` (located in `APPS` Tab)
- Click on `+` sign in Add Main File, Select `ks3_compiled.m` and Click `Open`
- In the section `Files required for your application to run`:
	- Click on `+` sign button, Select `utils` folder and click `Open`
	- Click on `+` sign button again, Select the folder of the cloned `Kilosort` project and click `Open`
- On Application Compiler window, Click on `Package`, Save the `ks3_compiled.prj` file and wait for Matlab to Compile the project. A folder (named `ks3_compiled` by default) with compiled files will be generated.
- Close `Package` and `Application Compiler` windows

## Generating Base Docker Image
- In Matlab console run:
```
compiler.package.docker('ks3_compiled/for_testing/ks3_compiled', 'ks3_compiled/for_testing/requiredMCRProducts.txt', 'ImageName', 'ks3-matlab-base')
```

This command will create an image called `ks3-matlab-base` to be used in the next step

## Extending Base Image/Creating final image
The Dockerfile in this folder applies some fixes and updates to the base image generated automatically by Matlab in order to properly run kilosort3:

- In your terminal, go to the current folder:
```
$ cd /path/to/spikeinterface-dockerfiles/kilosort3-compiled
```

- Run build script:
```
$ source build.sh
```


## Running a container

The base syntax to run dockerized kilosort is:

```
docker run -v <host-data-folder>:<docker-data-folder> -it spikeinterface/kilosort3-compiled-base:0.1.0 ks3_compiled [ARGS]
```

Notice that a volume has to be binded to a folder were all the data to run kilosort3 are stored

Currently the only ARG option is the folder where the data are stored (\<docker-data-folder\>)

This kilosort3 compiled version assumes that there are also two `.mat` files in this data folder:
1. `ops.mat`: Configurations (options) data
2. `chanMap.mat`: ChannelMap data

Both files are automatically generated by spikeinterface when running `run\_sorter`. If you want to run compiled kilosort independently you need to generate them manually (HOW TO still needs to be done)

