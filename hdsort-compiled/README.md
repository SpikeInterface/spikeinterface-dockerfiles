# HDsort Compiled Docker Images

This documentation is intended to show how to create a Docker image with Matlab compiled HDsort sorter. The main goal of this project is to avoid the requirement of Matlab Licenses and also abstract the installation and setup steps to run the sorter

There are three main steps for generating a functional HDsort docker image:
1. Compile HDsort as Matlab's Standalone Application
2. Create a (base) docker image with Matlab Runtime and the compiled application from step 1
3. Extend the docker image from step 2 for improvements and fixes

## Requirements
- Packaging a MATLAB Docker image is supported on Linux only
- Docker
- Matlab

### Matlab Requirements
- MATLAB Compiler
- More requirements to be checked and listed...

## Compiling HDsort as Matlab's Standalone Application
- Git clone or Download HDsort [source code](https://git.bsse.ethz.ch/hima_public/HDsort)
- Open Matlab
- Set Matlab's workspace folder to `/path/to/spikeinterface-dockerfiles/hdsort-compiled`
- Run `mcc` command with `hdsort_compiled.m` as base and adding path to git cloned HDSort:
```matlab
>> mcc -m hdsort_compiled.m -a <git-cloned-path>/HDsort
```

## Generating Base Docker Image
- To generate the base docker image (called `hdsort-matlab-base`) with the compiled application, run the following command in Matlab console:
```matlab
>> compiler.package.docker('hdsort_compiled', 'requiredMCRProducts.txt', 'ImageName', 'hdsort-matlab-base')
```


- [Optional] Files generated by Matlab Compiler can be deleted:
  - In your terminal, go to the `hdsort-compiled` folder in this project:
  ```bash
  $ cd /path/to/spikeinterface-dockerfiles/hdsort-compiled
  ```

  - Run `rm` command:
  ```bash
  $ rm -r \
    hdsort-matlab-basedocker \
    hdsort_compiled \
    includedSupportPackages.txt \
    mccExcludedFiles.log \
    readme.txt \
    requiredMCRProducts.txt \
    run_hdsort_compiled.sh \
    unresolvedSymbols.txt
  ```


## Extending Base Image and creating final image
The Dockerfile in this folder applies some fixes and updates to the base image generated automatically by Matlab in order to properly run waveclus:


- In your terminal, go to the  folder for this project:
```
$ cd /path/to/spikeinterface-dockerfiles/hdsort-compiled
```

- Run build script:
```
$ source build.sh
```
