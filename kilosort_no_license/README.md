# Kilosort Compiled Docker Images

This documentation is intended to show how to create a Docker image with Matlab compiled implementation of Kilosort sorter. The main goal of this project is to avoid the requirement of Matlab Licenses and also abstract the installation and setup steps to run kilosort

## Requirements
- Packaging a MATLAB Docker image is supported on Linux only
- Docker
- Matlab
- NVIDIA GPU and CUDA capabilities

### Matlab Requirements
- MATLAB Compiler
- Parallel Computing Toolbox
- Signal Processing Toolbox
- Statistics and Machine Learning Toolbox

## Creating Docker Image

There are four main steps to generate a functional kilosort-compiled docker image:

1. Compile Kilosort CUDA files
2. Compile Kilosort as Standalone Application
3. Create a (base) docker image with Matlab Runtime and the compiled application from step 2
4. Extend the docker image from step 3 for improvements and fixes

Steps 1 to 3 are done by `compile.sh` script, while step 4 is done by `build.sh` script.

Steps to run scripts and create the images are documented in `README.md` for each supported kilosort version folder (`kilosort-compiled`, `kilosort2-compiled` and so on)

Licenses for Matlab and toolboxes are needed only for compiling kilosort as Standalone Application and to generate the base Docker image. After this process, no license will be required, either to extend the base image or to run the sorter.

## Running a container

After generating kilosort-compiled image, [nvidia-container-toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#setting-up-nvidia-container-toolkit) is required to run a docker with GPU capabilities

The base syntax to run dockerized kilosort is:

```bash
docker run -v <host-data-folder>:<docker-data-folder> <image>:<tag> <ks_command> [ARGS]
```
- A volume has to be binded to a folder were all the data to run kilosort are stored
- `<image>`: Image name given by `build.sh` script
- `<tag>`: Image Tag given by `build.sh` script
- `<ks_command>`: Depends on kilosort version, options are `ks_compiled`, `ks2_compiled`, `ks2_5_compiled` or `ks3_compiled`
- `[ARGS]`: Currently the only ARG option is the folder where the data are stored (\<docker-data-folder\>)

This kilosort compiled version assumes that there are also two `.mat` files in this data folder:
1. `ops.mat`: Configurations (options) data
2. `chanMap.mat`: ChannelMap data

Both files are automatically generated by spikeinterface when running `run\_sorter`. If you want to run compiled kilosort independently you need to generate them manually (HOW TO still needs to be done)
